<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Command Manager</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: Arial, sans-serif;
            font-size: 16px;
            line-height: 1.5;
        }

        body {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            background: #f5f5f5;
            margin: 0;
        }

        .container {
            display: flex;
            flex: 1;
        }

        .sidebar {
            width: 280px;
            background: #1a253f;
            color: white;
            padding: 20px;
            position: relative;
            overflow-y: auto;
            height: calc(100vh - 40px); /* Full height minus footer */
            z-index: 1;
        }

        .sidebar-header {
            margin-bottom: 20px;
        }

        .sidebar-header h2 {
            font-size: 18px;
            font-weight: bold;
            color: white;
        }

        .main-content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            height: calc(100vh - 40px); /* Full height minus footer */
            z-index: 1;
        }

        .domain-title {
            margin-bottom: 20px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            height: 32px;
            font-size: 16px;
            line-height: 1.2;
        }

        .input-group {
            margin-bottom: 15px;
        }

        .input-group label {
            display: block;
            margin-bottom: 5px;
            font-size: 16px;
            line-height: 1.5;
            color: white;
        }

        .input-group input,
        .input-group select {
            width: 100%;
            padding: 8px;
            margin-bottom: 5px;
            height: 32px;
            font-size: 14px;
            line-height: 1.2;
            border-radius: 4px;
            border: 1px solid #ddd;
            box-sizing: border-box;
            background: #2e3b5b;
            color: white;
        }

        .input-group button {
            border: none;
            background: transparent;
            color: white;
        }

        .sidebar button {
            width: 100%;
            height: 40px;
            padding: 8px 12px;
            font-size: 14px;
            line-height: 1.2;
            border: none;
            border-radius: 4px;
            background: transparent;
            color: white;
            cursor: pointer;
            margin-bottom: 5px;
            box-sizing: border-box;
            text-align: left;
            transition: background 0.3s ease;
        }

        .sidebar button:hover {
            background: #2e3b5b;
        }

        .command-input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 5px;
        }

        .command-input-group input {
            flex: 1;
            height: 32px;
            padding: 8px;
            font-size: 14px;
            line-height: 1.2;
            border-radius: 4px;
            border: 1px solid #ddd;
        }

        .command-input-group input.note-input {
            flex: 0 0 200px;
            height: 32px;
            padding: 8px;
            font-size: 14px;
            line-height: 1.2;
        }

        .batch-list,
        .command-group-list {
            margin-top: 20px;
        }

        .batch-item,
        .command-group {
            margin-bottom: 10px;
        }

        .batch-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            height: 40px;
            margin-bottom: 10px;
        }

        .batch-item button {
            flex: 1;
            height: 40px;
            margin-right: 10px;
            background: transparent;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 14px;
            cursor: pointer;
            text-align: left;
            padding: 8px 12px;
            box-sizing: border-box;
            transition: background 0.3s ease;
        }

        .batch-item button:hover {
            background: #2e3b5b;
        }

        .command-entry {
            margin: 10px 0;
            padding: 8px;
            background: #f9f9f9;
            display: flex;
            flex-direction: column;
            border-radius: 4px;
        }

        .command-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            height: 32px;
        }

        .command-text {
            flex: 1;
            margin-right: 10px;
            font-size: 14px;
            line-height: 1.2;
            white-space: nowrap; /* Prevent text wrapping */
            overflow: hidden; /* Hide overflow */
            text-overflow: ellipsis; /* Add ellipsis for long text */
        }

        .command-note {
            font-size: 14px;
            line-height: 1.2;
            color: #666;
            margin-top: 5px;
            font-style: italic;
        }

        button {
            padding: 0;
            height: 32px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            background: #1a253f;
            color: white;
            margin-left: 5px;
            font-size: 14px;
            line-height: 32px;
            text-align: center;
            min-width: 120px;
        }

        button:hover {
            background: #1a253f;
        }

        .options-btn {
            background: #1a253f;
            color: white;
            padding: 0;
            height: 32px;
            line-height: 32px;
            min-width: 70px;
            font-size: 14px;
        }

        .options-btn:hover {
            background: #1a253f;
        }

        .batch-item .dots-menu {
            background: transparent;
            color: white;
            padding: 0;
            height: 40px;
            line-height: 40px;
            min-width: 40px;
            font-size: 14px;
            border: none;
            border-radius: 4px;
            transition: background 0.3s ease;
        }

        .batch-item .dots-menu:hover {
            background: #2e3b5b;
        }

        .dropdown {
            position: relative;
            display: inline-block;
        }

        .dropdown-content {
            display: none;
            position: absolute;
            right: 0;
            background: white;
            min-width: 100px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            z-index: 1;
        }

        .dropdown:hover .dropdown-content {
            display: block;
        }

        .dropdown-content button {
            display: block;
            width: 100%;
            padding: 0;
            height: 32px;
            line-height: 32px;
            text-align: left;
            background: white;
            color: black;
            font-size: 14px;
        }

        .dropdown-content button:hover {
            background: #f0f0f0;
        }

        .menu-toggle {
            position: relative;
            margin-bottom: 20px;
        }

        .sidebar-menu {
            position: fixed;
            top: 0;
            left: -280px;
            width: 280px;
            height: 100%;
            background: #1a253f;
            padding: 20px;
            transition: left 0.3s ease;
            z-index: 1001;
            color: white;
            box-shadow: 2px 0 5px rgba(0, 0, 0, 0.3);
        }

        .sidebar-menu.open {
            left: 0;
        }

        .sidebar-menu button {
            display: flex;
            justify-content: center;
            align-items: center;
            width: 100%;
            height: 40px;
            padding: 0;
            margin-bottom: 10px;
            background: transparent;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 14px;
            cursor: pointer;
            text-align: left;
            transition: background 0.3s ease;
        }

        .sidebar-menu button:hover {
            background: #2e3b5b;
        }

        .overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
        }

        .overlay.active {
            display: block;
        }

        .popup {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1003;
        }

        .popup-content {
            background: white;
            padding: 20px;
            border-radius: 8px;
            width: 300px;
            text-align: center;
            position: relative;
        }

        #popup-body button {
            display: flex;
            justify-content: center;
            align-items: center;
            width: 100%;
            height: 40px;
            padding: 0;
            margin: 5px 0;
            background: #1a253f;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 14px;
            cursor: pointer;
            box-sizing: border-box;
            line-height: normal;
        }

        #popup-body button:hover {
            background: #1a253f;
        }

        #popup-body input {
            width: 100%;
            padding: 8px;
            margin: 10px 0;
            height: 32px;
            font-size: 14px;
            border-radius: 4px;
            border: 1px solid #ddd;
        }

        #popup-body select {
            width: 100%;
            padding: 8px;
            margin: 10px 0;
            height: 32px;
            font-size: 14px;
            border-radius: 4px;
            border: 1px solid #ddd;
        }

        footer {
            position: fixed;
            bottom: 0;
            width: 100%;
            background: #2c3e50;
            color: white;
            text-align: center;
            padding: 10px 0;
            height: 40px;
            z-index: 2;
        }

        footer a {
            color: #658ca5;
            text-decoration: none;
        }

        footer a:hover {
            text-decoration: underline;
        }
    </style>
</head>
<body>
    <div class="overlay"></div>
    <div class="container">
        <div class="sidebar">
            <div class="sidebar-header">
                <h2>Command Manager</h2>
            </div>
            <div class="menu-toggle">
                <button onclick="toggleSidebar()">Options</button>
            </div>

            <div class="input-group">
                <label for="domainInput">Target Domain</label>
                <input type="text" id="domainInput" placeholder="example.com">
                <button onclick="analyzeDomain()">Analyze</button>
            </div>

            <div class="batch-list" id="batchList">
                <!-- Batches will be populated here -->
            </div>

            <button onclick="toggleView()">Toggle View</button>
        </div>

        <div class="main-content">
            <input type="text" class="domain-title" id="domainTitle" value="Command Manager">
            
            <div class="command-group-list" id="commandGroupList">
                <!-- Command groups will be populated here -->
            </div>
        </div>
    </div>

    <div class="sidebar-menu" id="sidebarMenu">
        <button onclick="event.stopPropagation(); showPopup('addBatch');">Add Batch</button>
        <button onclick="event.stopPropagation(); showPopup('addCommandGroup');">Add Command Group</button>
        <button onclick="event.stopPropagation(); showActionPopup();">Manage Data</button>
    </div>

    <div id="popup" class="popup" style="display: none;">
        <div class="popup-content">
            <h3 id="popup-title"></h3>
            <div id="popup-body"></div>
        </div>
    </div>

    <footer>
        <p>Developed by <a href="https://www.linkedin.com/in/siuxsa/" target="_blank">_SA_SHORIF_</a></p>
    </footer>

    <script>
        // Persistent storage (saved to localStorage)
        let persistentBatches = {};
        let persistentCommandGroups = {};
        // Session state (temporary in-memory state)
        let sessionBatches = {};
        let sessionCommandGroups = {};
        let currentView = 'all';
        let currentBatch = null;
        let currentDomain = 'target.com';

        // Initialize data with error handling
        try {
            const storedBatches = localStorage.getItem('batches');
            const storedCommandGroups = localStorage.getItem('commandGroups');
            persistentBatches = storedBatches ? JSON.parse(storedBatches) : {};
            persistentCommandGroups = storedCommandGroups ? JSON.parse(storedCommandGroups) : {};
            // Initialize session state with persistent data
            sessionBatches = { ...persistentBatches };
            sessionCommandGroups = { ...persistentCommandGroups };
            console.log('Initial data loaded:', { persistentBatches, persistentCommandGroups });
        } catch (error) {
            console.error('Error loading data from localStorage:', error);
            persistentBatches = {};
            persistentCommandGroups = {};
            sessionBatches = {};
            sessionCommandGroups = {};
            localStorage.setItem('batches', JSON.stringify(persistentBatches));
            localStorage.setItem('commandGroups', JSON.stringify(persistentCommandGroups));
        }

        function saveData() {
            try {
                localStorage.setItem('batches', JSON.stringify(persistentBatches));
                localStorage.setItem('commandGroups', JSON.stringify(persistentCommandGroups));
                console.log('Data saved:', { persistentBatches, persistentCommandGroups });
            } catch (error) {
                console.error('Error saving data to localStorage:', error);
            }
        }

        function analyzeDomain() {
            try {
                const newDomain = document.getElementById('domainInput').value.trim() || 'example.com';
                console.log('New domain:', newDomain);
                console.log('Current domain before update:', currentDomain);

                currentDomain = newDomain;
                document.getElementById('domainTitle').value = `Commands for ${newDomain}`;

                // Only update domain-related data, preserve existing deletions
                Object.entries(sessionBatches).forEach(([batchId, batch]) => {
                    if (batch.name.toLowerCase().includes('target.com')) {
                        console.log('Updating session batch name from:', batch.name);
                        batch.name = batch.name.replace(/target\.com/gi, newDomain);
                        console.log('Updated session batch name to:', batch.name);
                    }
                });

                Object.entries(sessionCommandGroups).forEach(([groupId, group]) => {
                    if (group.title.toLowerCase().includes('target.com')) {
                        console.log('Updating session group title from:', group.title);
                        group.title = group.title.replace(/target\.com/gi, newDomain);
                        console.log('Updated session group title to:', group.title);
                    }
                    group.commands.forEach((cmd, index) => {
                        if (cmd.command.toLowerCase().includes('target.com')) {
                            console.log('Updating session command from:', cmd.command);
                            cmd.command = cmd.command.replace(/target\.com/gi, newDomain);
                            console.log('Updated session command to:', cmd.command);
                            sessionCommandGroups[groupId].commands[index] = { ...cmd };
                        }
                        if (cmd.note && cmd.note.toLowerCase().includes('target.com')) {
                            console.log('Updating session note from:', cmd.note);
                            cmd.note = cmd.note.replace(/target\.com/gi, newDomain);
                            console.log('Updated session note to:', cmd.note);
                            sessionCommandGroups[groupId].commands[index] = { ...cmd };
                        }
                    });
                });

                // Sync persistent state with session state to preserve deletions
                persistentBatches = { ...sessionBatches };
                persistentCommandGroups = { ...sessionCommandGroups };
                saveData(); // Save the updated state

                renderCommandGroups();
                renderBatches();
                alert(`Domain temporarily updated to: ${newDomain}. Changes will revert on refresh.`);
            } catch (error) {
                console.error('Error in analyzeDomain:', error);
                alert('An error occurred while updating the domain. Check the console for details.');
            }
        }

        function createBatch() {
            try {
                const batchName = document.getElementById('popup-batch-name').value;
                if (batchName) {
                    const batchId = Date.now().toString();
                    sessionBatches[batchId] = {
                        name: batchName.replace(/target\.com/gi, currentDomain),
                        commandGroups: []
                    };
                    persistentBatches[batchId] = { ...sessionBatches[batchId] };
                    saveData();
                    renderBatches();
                }
            } catch (error) {
                console.error('Error in createBatch:', error);
            }
        }

        function renderBatches() {
            try {
                const batchList = document.getElementById('batchList');
                batchList.innerHTML = '';
                const currentBatches = (currentDomain !== 'target.com') ? sessionBatches : persistentBatches;
                Object.entries(currentBatches).forEach(([batchId, batch]) => {
                    const batchDiv = document.createElement('div');
                    batchDiv.className = 'batch-item';
                    batchDiv.innerHTML = `
                        <button onclick="showBatchCommands('${batchId}')">${batch.name}</button>
                        <div class="dropdown">
                            <button class="dots-menu">⋮</button>
                            <div class="dropdown-content">
                                <button onclick="moveBatchToTop('${batchId}')">Move to Top</button>
                                <button onclick="editBatch('${batchId}')">Edit</button>
                                <button onclick="deleteBatch('${batchId}')">Delete</button>
                            </div>
                        </div>
                    `;
                    batchList.appendChild(batchDiv);
                });
            } catch (error) {
                console.error('Error in renderBatches:', error);
            }
        }

        function updateBatchSelect() {
            try {
                const select = document.getElementById('batchSelect');
                if (!select) {
                    console.warn('batchSelect element not found, skipping update');
                    return;
                }
                select.innerHTML = '<option value="">Select Batch (Optional)</option>';
                const currentBatches = (currentDomain !== 'target.com') ? sessionBatches : persistentBatches;
                Object.entries(currentBatches).forEach(([batchId, batch]) => {
                    const option = document.createElement('option');
                    option.value = batchId;
                    option.textContent = batch.name;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('Error in updateBatchSelect:', error);
            }
        }

        function moveBatchToTop(batchId) {
            try {
                const currentBatches = (currentDomain !== 'target.com') ? sessionBatches : persistentBatches;
                const batch = currentBatches[batchId];
                delete currentBatches[batchId];
                currentBatches[batchId] = batch;
                const batchesArray = Object.entries(currentBatches);
                batchesArray.sort((a, b) => (a[0] === batchId ? -1 : 1));
                const sortedBatches = Object.fromEntries(batchesArray);
                if (currentDomain !== 'target.com') {
                    sessionBatches = sortedBatches;
                } else {
                    persistentBatches = sortedBatches;
                    saveData();
                }
                renderBatches();
            } catch (error) {
                console.error('Error in moveBatchToTop:', error);
            }
        }

        function editBatch(batchId) {
            try {
                const currentBatches = (currentDomain !== 'target.com') ? sessionBatches : persistentBatches;
                const newName = prompt('Enter new batch name:', currentBatches[batchId].name);
                if (newName && newName !== currentBatches[batchId].name) {
                    currentBatches[batchId].name = newName.replace(/target\.com/gi, currentDomain);
                    if (currentDomain !== 'target.com') {
                        sessionBatches[batchId] = { ...currentBatches[batchId] };
                    } else {
                        persistentBatches[batchId] = { ...currentBatches[batchId] };
                        saveData();
                    }
                    renderBatches();
                }
            } catch (error) {
                console.error('Error in editBatch:', error);
            }
        }

        function deleteBatch(batchId) {
            try {
                const currentBatches = (currentDomain !== 'target.com') ? sessionBatches : persistentBatches;
                if (confirm(`Delete batch ${currentBatches[batchId].name}?`)) {
                    // Remove the batch from both session and persistent storage
                    Object.values(sessionCommandGroups).forEach(group => {
                        if (group.batchId === batchId) {
                            group.batchId = null;
                        }
                    });
                    delete currentBatches[batchId];
                    // Sync session and persistent states
                    if (currentDomain !== 'target.com') {
                        sessionBatches = { ...currentBatches };
                        persistentBatches = { ...currentBatches }; // Sync persistent state
                    } else {
                        persistentBatches = { ...currentBatches };
                        sessionBatches = { ...persistentBatches }; // Sync session state
                    }
                    saveData(); // Save the changes
                    renderBatches();
                    renderCommandGroups();
                }
            } catch (error) {
                console.error('Error in deleteBatch:', error);
            }
        }

        function showBatchCommands(batchId) {
            currentBatch = batchId;
            currentView = 'batch';
            renderCommandGroups();
        }

        function addCommandGroup() {
            try {
                const groupTitle = document.getElementById('popup-group-title').value;
                const batchId = document.getElementById('popup-batch-select').value;
                if (groupTitle) {
                    const groupId = Date.now().toString();
                    sessionCommandGroups[groupId] = {
                        title: groupTitle.replace(/target\.com/gi, currentDomain),
                        commands: [],
                        batchId: batchId || null
                    };
                    persistentCommandGroups[groupId] = { ...sessionCommandGroups[groupId] };
                    if (batchId) {
                        const currentBatches = (currentDomain !== 'target.com') ? sessionBatches : persistentBatches;
                        currentBatches[batchId].commandGroups.push(groupId);
                        if (currentDomain === 'target.com') {
                            persistentBatches[batchId] = { ...currentBatches[batchId] };
                            saveData();
                        }
                    }
                    saveData();
                    renderCommandGroups();
                }
            } catch (error) {
                console.error('Error in addCommandGroup:', error);
            }
        }

        function renderCommandGroups() {
            try {
                const groupList = document.getElementById('commandGroupList');
                groupList.innerHTML = '';
                const currentCommandGroups = (currentDomain !== 'target.com') ? sessionCommandGroups : persistentCommandGroups;
                const currentBatches = (currentDomain !== 'target.com') ? sessionBatches : persistentBatches;
                
                Object.entries(currentCommandGroups).forEach(([id, group]) => {
                    const shouldShow = currentView === 'all' || 
                        (currentView === 'batch' && currentBatch && group.batchId === currentBatch);
                    
                    if (shouldShow) {
                        const groupDiv = document.createElement('div');
                        groupDiv.className = 'command-group';
                        groupDiv.innerHTML = `
                            <h3>${group.title}${group.batchId ? ' (' + currentBatches[group.batchId]?.name + ')' : ''}</h3>
                            <div class="commands">
                                ${group.commands.map((cmd, idx) => `
                                    <div class="command-entry">
                                        <div class="command-content">
                                            <span class="command-text">${cmd.command}</span>
                                            <div>
                                                <button class="copy-btn" data-command="${encodeURIComponent(cmd.command)}">Copy</button>
                                                <div class="dropdown">
                                                    <button class="options-btn">Options</button>
                                                    <div class="dropdown-content">
                                                        <button onclick="editCommand('${id}', ${idx})">Edit</button>
                                                        <button onclick="moveCommandUp('${id}', ${idx})">Move Up</button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        ${cmd.note ? `<div class="command-note">Note: ${cmd.note}</div>` : ''}
                                    </div>
                                `).join('')}
                            </div>
                            <div class="command-input-group">
                                <input type="text" placeholder="New command (e.g., ping target.com)" id="newCmd_${id}">
                                <input type="text" class="note-input" placeholder="Short note (optional)" id="newNote_${id}">
                            </div>
                            <button onclick="addCommand('${id}')">Add Command</button>
                            <button onclick="copyAllCommands('${id}')">Copy All</button>
                            <div class="dropdown">
                                <button>Actions</button>
                                <div class="dropdown-content">
                                    <button onclick="moveCommandGroupToTop('${id}')">Move to Top</button>
                                    <button onclick="editCommandGroup('${id}')">Edit</button>
                                    <button onclick="deleteCommandGroup('${id}')">Delete</button>
                                </div>
                            </div>
                        `;
                        groupList.appendChild(groupDiv);

                        // Attach event listeners to copy buttons
                        const copyButtons = groupDiv.querySelectorAll('.copy-btn');
                        copyButtons.forEach(button => {
                            button.addEventListener('click', () => {
                                const command = decodeURIComponent(button.getAttribute('data-command'));
                                copyToClipboard(command);
                            });
                        });
                    }
                });
            } catch (error) {
                console.error('Error in renderCommandGroups:', error);
            }
        }

        function moveCommandUp(groupId, commandIndex) {
            try {
                const currentCommandGroups = (currentDomain !== 'target.com') ? sessionCommandGroups : persistentCommandGroups;
                const commands = currentCommandGroups[groupId].commands;
                
                if (commandIndex === 0) {
                    return;
                }

                const temp = commands[commandIndex - 1];
                commands[commandIndex - 1] = commands[commandIndex];
                commands[commandIndex] = temp;

                currentCommandGroups[groupId].commands = commands;
                if (currentDomain !== 'target.com') {
                    sessionCommandGroups[groupId] = { ...currentCommandGroups[groupId] };
                } else {
                    persistentCommandGroups[groupId] = { ...currentCommandGroups[groupId] };
                    saveData();
                }

                renderCommandGroups();
            } catch (error) {
                console.error('Error in moveCommandUp:', error);
            }
        }

        function addCommand(groupId) {
            try {
                const commandInput = document.getElementById(`newCmd_${groupId}`);
                const noteInput = document.getElementById(`newNote_${groupId}`);
                let command = commandInput.value.trim();
                const note = noteInput.value.trim();
                
                if (command) {
                    command = command.replace(/target\.com/gi, currentDomain);
                    sessionCommandGroups[groupId].commands.push({
                        command,
                        note: note || ''
                    });
                    persistentCommandGroups[groupId] = { ...sessionCommandGroups[groupId] };
                    saveData();
                    commandInput.value = '';
                    noteInput.value = '';
                    renderCommandGroups();
                }
            } catch (error) {
                console.error('Error in addCommand:', error);
            }
        }

        function editCommand(groupId, commandIndex) {
            try {
                const currentCommandGroups = (currentDomain !== 'target.com') ? sessionCommandGroups : persistentCommandGroups;
                const currentCommand = currentCommandGroups[groupId].commands[commandIndex];
                const newCommand = prompt('Edit command:', currentCommand.command);
                const newNote = prompt('Edit note:', currentCommand.note);
                
                if (newCommand !== null && newCommand.trim() !== '') {
                    const updatedCommand = newCommand.replace(/target\.com/gi, currentDomain);
                    currentCommandGroups[groupId].commands[commandIndex] = {
                        command: updatedCommand,
                        note: newNote || ''
                    };
                    if (currentDomain !== 'target.com') {
                        sessionCommandGroups[groupId] = { ...currentCommandGroups[groupId] };
                    } else {
                        persistentCommandGroups[groupId] = { ...currentCommandGroups[groupId] };
                        saveData();
                    }
                    renderCommandGroups();
                }
            } catch (error) {
                console.error('Error in editCommand:', error);
            }
        }

        function copyToClipboard(text) {
            try {
                navigator.clipboard.writeText(text).then(() => {
                    alert('Command copied to clipboard!');
                }, () => {
                    alert('Clipboard access denied. Copy manually: ' + text);
                });
            } catch (error) {
                console.error('Error in copyToClipboard:', error);
                alert('Failed to copy command. Check the console for details.');
            }
        }

        function copyAllCommands(groupId) {
            try {
                const currentCommandGroups = (currentDomain !== 'target.com') ? sessionCommandGroups : persistentCommandGroups;
                const commands = currentCommandGroups[groupId].commands.map(cmd => cmd.command).join('\n');
                navigator.clipboard.writeText(commands);
                alert('All commands copied to clipboard!');
            } catch (error) {
                console.error('Error in copyAllCommands:', error);
            }
        }

        function moveCommandGroupToTop(groupId) {
            try {
                const currentCommandGroups = (currentDomain !== 'target.com') ? sessionCommandGroups : persistentCommandGroups;
                const group = currentCommandGroups[groupId];
                delete currentCommandGroups[groupId];
                currentCommandGroups[groupId] = group;
                const groupsArray = Object.entries(currentCommandGroups);
                groupsArray.sort((a, b) => (a[0] === groupId ? -1 : 1));
                const sortedGroups = Object.fromEntries(groupsArray);
                if (currentDomain !== 'target.com') {
                    sessionCommandGroups = sortedGroups;
                } else {
                    persistentCommandGroups = sortedGroups;
                    saveData();
                }
                renderCommandGroups();
            } catch (error) {
                console.error('Error in moveCommandGroupToTop:', error);
            }
        }

        function editCommandGroup(groupId) {
            try {
                const currentCommandGroups = (currentDomain !== 'target.com') ? sessionCommandGroups : persistentCommandGroups;
                const newTitle = prompt('Enter new title:', currentCommandGroups[groupId].title);
                if (newTitle) {
                    currentCommandGroups[groupId].title = newTitle.replace(/target\.com/gi, currentDomain);
                    if (currentDomain !== 'target.com') {
                        sessionCommandGroups[groupId] = { ...currentCommandGroups[groupId] };
                    } else {
                        persistentCommandGroups[groupId] = { ...currentCommandGroups[groupId] };
                        saveData();
                    }
                    renderCommandGroups();
                }
            } catch (error) {
                console.error('Error in editCommandGroup:', error);
            }
        }

        function deleteCommandGroup(groupId) {
            try {
                const currentCommandGroups = (currentDomain !== 'target.com') ? sessionCommandGroups : persistentCommandGroups;
                if (confirm('Delete this command group?')) {
                    const batchId = currentCommandGroups[groupId].batchId;
                    if (batchId) {
                        const currentBatches = (currentDomain !== 'target.com') ? sessionBatches : persistentBatches;
                        currentBatches[batchId].commandGroups = currentBatches[batchId].commandGroups.filter(id => id !== groupId);
                        if (currentDomain === 'target.com') {
                            persistentBatches[batchId] = { ...currentBatches[batchId] };
                        } else {
                            sessionBatches[batchId] = { ...currentBatches[batchId] };
                        }
                    }
                    delete currentCommandGroups[groupId];
                    // Sync session and persistent states
                    if (currentDomain !== 'target.com') {
                        sessionCommandGroups = { ...currentCommandGroups };
                        persistentCommandGroups = { ...currentCommandGroups }; // Sync persistent state
                    } else {
                        persistentCommandGroups = { ...currentCommandGroups };
                        sessionCommandGroups = { ...persistentCommandGroups }; // Sync session state
                    }
                    saveData(); // Save the changes
                    renderCommandGroups();
                }
            } catch (error) {
                console.error('Error in deleteCommandGroup:', error);
            }
        }

        function toggleView() {
            try {
                currentView = currentView === 'all' ? 'batch' : 'all';
                currentBatch = null;
                renderCommandGroups();
            } catch (error) {
                console.error('Error in toggleView:', error);
            }
        }

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebarMenu');
            const overlay = document.querySelector('.overlay');
            sidebar.classList.toggle('open');
            overlay.classList.toggle('active');
            console.log('Sidebar toggled, open:', sidebar.classList.contains('open'));
        }

        document.addEventListener('click', function(event) {
            const sidebar = document.getElementById('sidebarMenu');
            const optionsButton = document.querySelector('.menu-toggle button');
            const popup = document.getElementById('popup');
            const isPopupOpen = popup && popup.style.display === 'flex';

            if (!sidebar.contains(event.target) && event.target !== optionsButton && sidebar.classList.contains('open')) {
                sidebar.classList.remove('open');
                document.querySelector('.overlay').classList.remove('active');
                console.log('Sidebar closed by outside click');
            }

            if (isPopupOpen && !popup.contains(event.target) && !sidebar.contains(event.target) && event.target !== optionsButton) {
                hidePopup();
                console.log('Popup closed by outside click');
            }
        });

        let currentPopupAction = '';

        function showPopup(action) {
            currentPopupAction = action;
            const popup = document.getElementById('popup');
            const popupTitle = document.getElementById('popup-title');
            const popupBody = document.getElementById('popup-body');

            if (!popup || !popupTitle || !popupBody) {
                console.error('Popup elements not found');
                return;
            }

            popup.style.display = 'flex';
            console.log(`Showing popup for action: ${action} - Waiting 2 seconds to stay visible`);
            setTimeout(() => {
                console.log(`Popup for ${action} should be visible now`);
            }, 2000); // Keep popup visible for 2 seconds for debugging

            switch (action) {
                case 'addBatch':
                    popupTitle.textContent = 'Add New Batch';
                    popupBody.innerHTML = '<input type="text" id="popup-batch-name" placeholder="Batch Name"><button onclick="event.stopPropagation(); handlePopupSubmit();">Submit</button><button onclick="hidePopup()">Cancel</button>';
                    break;
                case 'addCommandGroup':
                    popupTitle.textContent = 'Add New Command Group';
                    popupBody.innerHTML = `
                        <input type="text" id="popup-group-title" placeholder="Group Title">
                        <select id="popup-batch-select">
                            <option value="">Select Batch (Optional)</option>
                        </select>
                        <button onclick="event.stopPropagation(); handlePopupSubmit();">Submit</button><button onclick="hidePopup()">Cancel</button>
                    `;
                    updatePopupBatchSelect();
                    break;
                default:
                    console.error('Unknown action in showPopup:', action);
                    hidePopup();
                    return;
            }
        }

        function showActionPopup() {
            currentPopupAction = 'selectDataAction';
            const popup = document.getElementById('popup');
            const popupTitle = document.getElementById('popup-title');
            const popupBody = document.getElementById('popup-body');

            if (!popup || !popupTitle || !popupBody) {
                console.error('Popup elements not found');
                return;
            }

            popup.style.display = 'flex';
            console.log('Showing Manage Data popup - Waiting 2 seconds to stay visible');
            setTimeout(() => {
                console.log('Manage Data popup should be visible now');
            }, 2000); // Keep popup visible for 2 seconds for debugging

            popupTitle.textContent = 'Manage Data';
            popupBody.innerHTML = `
                <button onclick="event.stopPropagation(); setAction('uploadData');">Upload</button>
                <button onclick="event.stopPropagation(); setAction('downloadData');">Download</button>
                <button onclick="hidePopup()">Close</button>
            `;
        }

        function setAction(action) {
            currentPopupAction = action;
            const popupBody = document.getElementById('popup-body');
            const popupTitle = document.getElementById('popup-title');

            if (!popupBody || !popupTitle) {
                console.error('Popup elements not found');
                return;
            }

            console.log(`Setting action to: ${action}`);
            switch (action) {
                case 'uploadData':
                    popupTitle.textContent = 'Upload Data';
                    popupBody.innerHTML = '<input type="file" id="popup-upload-data" accept=".json"><button onclick="event.stopPropagation(); handlePopupSubmit();">Submit</button><button onclick="hidePopup()">Cancel</button>';
                    break;
                case 'downloadData':
                    popupTitle.textContent = 'Download Data';
                    popupBody.innerHTML = '<p>Click Submit to download as command-manager-data.json.</p><button onclick="event.stopPropagation(); handlePopupSubmit();">Submit</button><button onclick="hidePopup()">Cancel</button>';
                    break;
                default:
                    console.error('Unknown action in setAction:', action);
                    hidePopup();
                    return;
            }
        }

        function updatePopupBatchSelect() {
            const select = document.getElementById('popup-batch-select');
            if (!select) {
                console.error('Batch select element not found');
                return;
            }
            select.innerHTML = '<option value="">Select Batch (Optional)</option>';
            const currentBatches = (currentDomain !== 'target.com') ? sessionBatches : persistentBatches;
            Object.entries(currentBatches).forEach(([batchId, batch]) => {
                const option = document.createElement('option');
                option.value = batchId;
                option.textContent = batch.name;
                select.appendChild(option);
            });
            console.log('Batch select updated');
        }

        function hidePopup() {
            const popup = document.getElementById('popup');
            if (popup) {
                popup.style.display = 'none';
                document.getElementById('popup-body').innerHTML = '';
                console.log('Popup hidden');
            } else {
                console.error('Popup element not found');
            }
        }

        function handlePopupSubmit() {
            try {
                console.log(`Handling submit for action: ${currentPopupAction}`);
                switch (currentPopupAction) {
                    case 'addBatch':
                        console.log('Processing addBatch action');
                        const batchName = document.getElementById('popup-batch-name').value;
                        if (batchName) {
                            const batchId = Date.now().toString();
                            sessionBatches[batchId] = {
                                name: batchName.replace(/target\.com/gi, currentDomain),
                                commandGroups: []
                            };
                            persistentBatches[batchId] = { ...sessionBatches[batchId] };
                            saveData();
                            renderBatches();
                        }
                        hidePopup();
                        break;
                    case 'addCommandGroup':
                        console.log('Processing addCommandGroup action');
                        const groupTitle = document.getElementById('popup-group-title').value;
                        const batchId = document.getElementById('popup-batch-select').value;
                        if (groupTitle) {
                            const groupId = Date.now().toString();
                            sessionCommandGroups[groupId] = {
                                title: groupTitle.replace(/target\.com/gi, currentDomain),
                                commands: [],
                                batchId: batchId || null
                            };
                            persistentCommandGroups[groupId] = { ...sessionCommandGroups[groupId] };
                            if (batchId) {
                                const currentBatches = (currentDomain !== 'target.com') ? sessionBatches : persistentBatches;
                                currentBatches[batchId].commandGroups.push(groupId);
                                if (currentDomain === 'target.com') {
                                    persistentBatches[batchId] = { ...currentBatches[batchId] };
                                    saveData();
                                }
                            }
                            saveData();
                            renderCommandGroups();
                        }
                        hidePopup();
                        break;
                    case 'uploadData':
                        console.log('Processing uploadData action');
                        const fileInput = document.getElementById('popup-upload-data');
                        const file = fileInput.files[0];
                        if (file) {
                            console.log('File selected for upload:', file.name);
                            const reader = new FileReader();
                            reader.onload = function(event) {
                                try {
                                    const uploadedData = JSON.parse(event.target.result);
                                    console.log('Uploaded data parsed:', uploadedData);
                                    if (!uploadedData.batches || !uploadedData.commandGroups) {
                                        throw new Error('Invalid JSON structure. Expected "batches" and "commandGroups" keys.');
                                    }

                                    persistentBatches = uploadedData.batches;
                                    persistentCommandGroups = uploadedData.commandGroups;
                                    sessionBatches = { ...persistentBatches };
                                    sessionCommandGroups = { ...persistentCommandGroups };

                                    saveData();
                                    renderBatches();
                                    renderCommandGroups();
                                    alert('Data uploaded successfully!');
                                    hidePopup();
                                } catch (error) {
                                    console.error('Error parsing uploaded JSON:', error);
                                    alert('Failed to upload data. The file might be invalid or corrupted. Check the console for details.');
                                }
                            };
                            reader.onerror = function() {
                                console.error('Error reading file');
                                alert('Failed to read the file. Check the console for details.');
                            };
                            reader.readAsText(file);
                        } else {
                            alert('Please select a file to upload.');
                        }
                        break;
                    case 'downloadData':
                        console.log('Processing downloadData action');
                        const data = {
                            batches: persistentBatches,
                            commandGroups: persistentCommandGroups
                        };
                        console.log('Data prepared for download:', data);
                        const dataStr = JSON.stringify(data, null, 2);
                        const blob = new Blob([dataStr], { type: 'application/json' });
                        const url = URL.createObjectURL(blob);
                        const link = document.createElement('a');
                        link.href = url;
                        link.download = 'command-manager-data.json';
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                        URL.revokeObjectURL(url);
                        console.log('Download triggered');
                        alert('Data downloaded successfully as command-manager-data.json');
                        hidePopup();
                        break;
                }
            } catch (error) {
                console.error('Error in handlePopupSubmit:', error);
                alert('An error occurred. Check the console for details.');
            }
        }

        try {
            renderBatches();
            renderCommandGroups();
            console.log('Initial render completed.');
        } catch (error) {
            console.error('Error during initial render:', error);
            alert('An error occurred during initial load. Check the console for details.');
        }
    </script>
</body>
</html>